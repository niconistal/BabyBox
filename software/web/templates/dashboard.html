{% extends "base.html" %}
{% block title %}BabyBox - Dashboard{% endblock %}
{% block heading %}Dashboard{% endblock %}

{% block body %}
<div class="card" id="now-playing">
    <h2>Now Playing</h2>
    <div id="playing-info">
        {% if status.now_playing %}
            <div class="now-playing-detail">
                {% if status.now_playing.thumbnail %}
                    <img src="/thumbnails/{{ status.now_playing.thumbnail }}" alt="" class="thumb-lg">
                {% endif %}
                <div>
                    <strong>{{ status.now_playing.title }}</strong>
                    <span class="badge {{ status.now_playing.media_type }}">{{ status.now_playing.media_type }}</span>
                </div>
            </div>
        {% else %}
            <p class="muted">Nothing playing — place a figurine to start!</p>
        {% endif %}
    </div>
    <p>State: <span id="state-badge" class="badge">{{ status.state }}</span></p>
</div>

<div class="card">
    <h2>Today's Video Usage</h2>
    <div class="stats-row">
        <div class="stat">
            <span class="stat-value" id="video-count">{{ status.video_stats.count }}</span>
            <span class="stat-label">/ {{ status.video_stats.limit_count }} videos</span>
        </div>
        <div class="stat">
            <span class="stat-value" id="video-minutes">{{ status.video_stats.total_minutes }}</span>
            <span class="stat-label">/ {{ status.video_stats.limit_minutes }} min</span>
        </div>
    </div>
    <div class="progress-bar">
        {% set pct = (status.video_stats.count / status.video_stats.limit_count * 100) if status.video_stats.limit_count > 0 else 0 %}
        <div class="progress-fill {% if pct >= 100 %}full{% elif pct >= 80 %}warning{% endif %}" style="width: {{ pct|int }}%"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Poll status every 3 seconds
    setInterval(async () => {
        const res = await fetch('/api/status');
        const s = await res.json();
        document.getElementById('state-badge').textContent = s.state;
        document.getElementById('video-count').textContent = s.video_stats.count;
        document.getElementById('video-minutes').textContent = s.video_stats.total_minutes;

        const info = document.getElementById('playing-info');
        if (s.now_playing) {
            let html = '<div class="now-playing-detail">';
            if (s.now_playing.thumbnail) {
                html += `<img src="/thumbnails/${s.now_playing.thumbnail}" alt="" class="thumb-lg">`;
            }
            html += `<div><strong>${esc(s.now_playing.title)}</strong>`;
            html += `<span class="badge ${s.now_playing.media_type}">${s.now_playing.media_type}</span></div></div>`;
            info.innerHTML = html;
        } else {
            info.innerHTML = '<p class="muted">Nothing playing — place a figurine to start!</p>';
        }
    }, 3000);
</script>
{% endblock %}
